<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>틱택토</title>
        <style>
            table {
                border-collapse: collapse;
            }
            td {
                border: 1px solid black;
                width: 40px;
                height: 40px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <script>
            const $table = document.createElement('table');
            const $result = document.createElement('div');
            const rows = [];
            let turn = 'o';

            const checkWinner = (target) => {
                const rowIndex = target.parentNode.rowIndex;
                const cellIndex = target.cellIndex;

                let hasWinner = false;
                // 세로
                if (
                    rows[0][cellIndex].textContent === turn &&
                    rows[1][cellIndex].textContent === turn &&
                    rows[2][cellIndex].textContent === turn
                ) {
                    hasWinner = true;
                }
                // 대각선
                if (
                    rows[0][0].textContent === turn &&
                    rows[1][1].textContent === turn &&
                    rows[2][2].textContent === turn
                ) {
                    hasWinner = true;
                }
                if (
                    rows[0][2].textContent === turn &&
                    rows[1][1].textContent === turn &&
                    rows[2][0].textContent === turn
                ) {
                    hasWinner = true;
                }
                // 가로
                if (
                    rows[rowIndex][0].textContent === turn &&
                    rows[rowIndex][1].textContent === turn &&
                    rows[rowIndex][2].textContent === turn
                ) {
                    hasWinner = true;
                }
                return hasWinner;
            };

            const checkWinnnerAndDraw = (target) => {
                const hasWinner = checkWinner(target);
                if (hasWinner) {
                    $result.textContent = `${turn} 승리!`;
                    $table.removeEventListener('click', callback);
                    return;
                }

                // 무승부 검사
                const draw = rows.flat().every((cell) => cell.textContent);
                if (draw) {
                    $result.textContent = '무승부!';
                    return;
                }

                turn = turn === 'o' ? 'x' : 'o';
            };

            let clikable = true;
            const callback = (e) => {
                if (!clikable) return;
                if (e.target.textContent) {
                    alert('빈칸이 아닙니다.');
                    return;
                }

                e.target.textContent = turn;
                checkWinnnerAndDraw(e.target);

                // 컴퓨터
                if (turn === 'x') {
                    clikable = false;
                    setTimeout(() => {
                        const emptyCells = rows
                            .flat()
                            .filter((v) => !v.textContent);
                        const randomCell =
                            emptyCells[
                                Math.floor(Math.random() * emptyCells.length)
                            ];
                        console.log('randomCell: ', randomCell);
                        randomCell.textContent = 'x';
                        checkWinnnerAndDraw(e.target);
                        clikable = true;
                    }, 1000);
                }
            };

            for (let i = 0; i < 3; i++) {
                const $tr = document.createElement('tr');
                const cells = [];
                for (let i = 0; i < 3; i++) {
                    const $td = document.createElement('td');
                    cells.push($td);
                    $tr.append($td);
                }
                $table.addEventListener('click', callback);
                $table.append($tr);
                rows.push(cells);
            }
            document.body.append($table);
            document.body.append($result);
        </script>
    </body>
</html>
